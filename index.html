<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvolutionGlute.IA - Rutinas para Glúteos</title>
    
    <meta name="theme-color" content="#F0218B">
    <link rel="apple-touch-icon" href="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/1e9600f3-7bbc-4f34-a86b-6b899f888ff2.png">
    <link rel="manifest" id="manifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://player.vimeo.com/api/player.js"></script>
    <style>
        /* AQUI VA TU CSS ORIGINAL COMPLETO */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');
        :root {
            --color-primary: #F0218B;   /* Rosa Fuerte Energético */
            --color-primary-dark: #C2185B;/* Rosa Oscuro */
            --color-secondary: #e74c3c;   /* Rojo para alertas/reemplazos */
            --color-accent: #f0f0f0;     /* Blanco roto para acentos sutiles */
            --color-dark: #0a0a0a;       /* Negro profundo */
            --color-light: #ffffff;
            --color-panel: rgba(20, 20, 20, 0.85); /* Panel carbón semi-transparente */
            --color-card: #2b2b2b;       /* Gris oscuro para tarjetas */
            --color-card-darker: #1c1c1c; /* Gris más oscuro */
            --color-text: #ecf0f1;
            --color-border: #444444;     /* Borde gris medio */
            --color-success: #27ae60;     /* Verde éxito */
            --glow-primary: rgba(240, 33, 139, 0.6);
            --glow-accent: rgba(240, 240, 240, 0.5);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Pega aquí el resto de tu CSS para que se vea bien */

    </style>
</head>
<body>

<div class="brazo-app-container">

    <div id="login-view" class="brazo-app-section active">
        <h1><strong>Evolution</strong>Glute</h1>
        <p>Inicia sesión para acceder a tus rutinas de glúteos.</p>
        <form id="login-form" class="auth-form">
            <div class="form-grid">
                <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div>
                <div class="form-group"><label for="login-password">Contraseña</label><input type="password" id="login-password" required></div>
            </div>
            <div class="form-buttons"><button type="submit" class="brazo-app-btn">Ingresar</button></div>
        </form>
        <form id="register-form" class="auth-form" style="display:none; margin-top: 20px;">
            <div class="form-grid">
                <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                <div class="form-group"><label for="register-password">Contraseña</label><input type="password" id="register-password" required minlength="6" placeholder="Mínimo 6 caracteres"></div>
                <div class="form-group"><label for="register-password-confirm">Confirmar Contraseña</label><input type="password" id="register-password-confirm" required minlength="6" placeholder="Repite la contraseña"></div>
            </div>
            <div class="form-buttons"><button type="submit" class="brazo-app-btn">Crear Cuenta</button></div>
        </form>
        <div class="auth-switch"><button id="toggle-auth-mode" class="brazo-app-btn brazo-app-btn-secondary">¿No tienes cuenta? Regístrate</button></div>
    </div>
    
    <div id="welcome" class="brazo-app-section">
        <h1><strong>Evolution</strong>Glute</h1>
        <p id="welcome-message">Tu entrenadora de glúteos inteligente.</p>
        <button id="install-pwa-btn" class="brazo-app-btn" style="display: none;"><i class="fa-solid fa-download"></i> Instalar App</button>

        <div id="subscription-area" style="margin: 20px 0;">
            <div id="wallet_container"><div class="spinner"></div></div>
        </div>
        <div id="main-app-buttons" style="display:none;">
            <button class="brazo-app-btn" data-target="routine-generator">Generar con IA</button>
            <button class="brazo-app-btn brazo-app-btn-secondary" data-target="custom-routine-creator">Crear Mi Rutina</button>
            <button class="brazo-app-btn brazo-app-btn-secondary" data-target="saved-routines-view">Mis Rutinas</button>
            <button class="brazo-app-btn brazo-app-btn-secondary" data-target="progress-view">Mi Progreso</button>
            <button class="brazo-app-btn brazo-app-btn-secondary" data-target="settings-view">Ajustes</button>
        </div>
        </div>
    
    </div>

<div id="modal" class="modal-overlay">
    </div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script type="module">
    // --- IMPORTACIONES DE FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIGURACIÓN DE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAm73lVXPJaccAwPJs8MyP8Mh8kBrvcAMM",
        authDomain: "appoficial-84d90.firebaseapp.com",
        projectId: "appoficial-84d90",
        storageBucket: "appoficial-84d90.appspot.com",
        messagingSenderId: "879173468964",
        appId: "1:879173468964:web:c0b715a48839bdbcd3a9b1",
        measurementId: "G-F4591FJ9C0"
    };

    // --- INICIALIZACIÓN DE FIREBASE ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUserId = null;

    // --- BASE DE DATOS DE EJERCICIOS ---
    const exerciseDatabase = [ /* ... Pega aquí tu base de datos de ejercicios ... */ ];

    // ===============================================
    // ========= LÓGICA DE LA APLICACIÓN =========
    // ===============================================

    // --- LÓGICA DE MERCADO PAGO ---
    function renderCheckoutButton() {
        const mp = new MercadoPago('APP_USR-8ec6b9fe-500c-4ad8-9c19-0ba035211799', { // Public Key de PRODUCCIÓN
            locale: 'es-AR'
        });
        fetch('/api/create_preference', { method: 'POST' })
        .then(res => {
            if (!res.ok) { return res.json().then(err => Promise.reject(err)); }
            return res.json();
        })
        .then(data => {
            if (data.id) {
                document.getElementById('wallet_container').innerHTML = '';
                mp.wallet({
                    preferenceId: data.id,
                    render: { container: '#wallet_container', label: 'Suscribirme' }
                });
            } else {
                throw new Error("No se recibió ID de preferencia.");
            }
        })
        .catch(error => {
            console.error("Error al renderizar botón:", error);
            const container = document.getElementById('wallet_container');
            if (container) container.innerText = `Error al generar botón de pago.`;
        });
    }

    // Lógica para verificar si el usuario ya está suscrito
    async function checkUserSubscriptionStatus() {
        const isSubscribed = false; 
        const subArea = document.getElementById('subscription-area');
        const mainButtons = document.getElementById('main-app-buttons');
        if (isSubscribed) {
            if (subArea) subArea.style.display = 'none';
            if (mainButtons) mainButtons.style.display = 'block';
        } else {
            if (subArea) subArea.style.display = 'block';
            if (mainButtons) mainButtons.style.display = 'none';
            renderCheckoutButton();
        }
    }

    // --- MANEJADOR DE AUTENTICACIÓN DE FIREBASE ---
    onAuthStateChanged(auth, (user) => {
        // Asegúrate de que todas las funciones que se usan aquí (como showSection)
        // estén definidas antes de este bloque.
        // Lo ideal es meter toda la lógica de tu app dentro de DOMContentLoaded
    });

    // --- LÓGICA ORIGINAL DE TU APLICACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- Pega aquí TODA tu lógica original ---
        // (variables, funciones showSection, showModal, event listeners, etc.)

        // Mueve la lógica de autenticación aquí adentro para más seguridad
        onAuthStateChanged(auth, (user) => {
            const welcomeMessage = document.getElementById('welcome-message');
            if (user) {
                currentUserId = user.uid;
                if (welcomeMessage) {
                    welcomeMessage.innerHTML = `Bienvenida de nuevo, <strong>${user.email.split('@')[0]}</strong>. ¿Lista para construir tu mejor versión?`;
                }
                if (window.showSection) window.showSection('welcome'); 
                checkUserSubscriptionStatus();
            } else {
                currentUserId = null;
                if (window.showSection) window.showSection('login-view');
            }
        });
    });
</script>
</body>
</html>