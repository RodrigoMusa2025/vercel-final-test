<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Pago Vercel</title>
    <style>
        body { 
            font-family: sans-serif; 
            background-color: #121212; 
            color: white; 
            display: grid; 
            place-content: center; 
            height: 100vh; 
            text-align: center; 
            margin: 0; 
        }
        .container { 
            background-color: #222; 
            padding: 40px; 
            border-radius: 10px; 
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3483FA;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto 0 auto;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prueba de Checkout</h1>
        <p>Aquí debería aparecer el botón de pago de Mercado Pago.</p>
        <div id="wallet_container">
             <div class="spinner"></div>
        </div>
    </div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Página cargada. Iniciando proceso de pago.");

            // 2. Inicializar Mercado Pago con tu Public Key de PRUEBA
            const mp = new MercadoPago('APP_USR-e1d628ce-0528-4da6-b257-507923c90431', {
                locale: 'es-AR'
            });

            // 3. Llamar a nuestra API para crear la preferencia
            console.log("Llamando a la API en /api/create_preference...");
            fetch('/api/create_preference', {
                method: 'POST'
            })
            .then(res => {
                if (!res.ok) {
                    // Si la respuesta no es OK, leemos el error que devuelve nuestra API
                    return res.json().then(errorData => {
                        throw new Error(`El servidor respondió con error ${res.status}: ${errorData.error}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                console.log("Preferencia recibida del servidor:", data);
                if (data.id) {
                    document.getElementById('wallet_container').innerHTML = ''; // Limpiamos el spinner
                    // 4. Renderizar el botón con el ID de preferencia
                    mp.wallet({
                        preferenceId: data.id,
                        render: {
                            container: '#wallet_container',
                            label: 'Pagar Prueba',
                        }
                    });
                    console.log("Botón de pago renderizado.");
                } else {
                    console.error("La respuesta del servidor no contiene un ID.");
                    document.getElementById('wallet_container').innerText = 'Error: No se recibió ID de preferencia.';
                }
            })
            .catch(error => {
                console.error("Error final:", error);
                document.getElementById('wallet_container').innerText = `Error: ${error.message}`;
            });
        });
    </script>
</body>
</html>